FROM ghcr.io/agentic-dev-io/claude-plugins:latest

USER root

# Install Python and pip for the proxy
RUN apt-get update && apt-get install -y python3 python3-pip python3-venv && rm -rf /var/lib/apt/lists/*

# Copy and install proxy
COPY ollama-proxy/ /opt/ollama-proxy/

# Fix line endings and make executable
RUN cd /opt/ollama-proxy && \
    pip3 install --break-system-packages -r requirements.txt && \
    sed -i 's/\r$//' start.sh && \
    chmod +x start.sh && \
    cp start.sh /usr/local/bin/start-with-proxy.sh

# Configure for local proxy
ENV ANTHROPIC_BASE_URL=http://localhost:8080
ENV ANTHROPIC_API_KEY=ollama
ENV OLLAMA_BASE_URL=http://host.docker.internal:11434/v1
ENV DO_NOT_TRACK=1

USER agent
WORKDIR /home/agent/workspace

ENTRYPOINT ["/usr/local/bin/start-with-proxy.sh"]
CMD []
